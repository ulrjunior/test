<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Date Myst√®re ‚ú®</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #ffe6e6, #e0f7fa);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #333;
      margin-top: 20px;
      text-align: center;
    }
    .tabs {
      display: flex;
      justify-content: center;
      background: #fff;
      border-bottom: 1px solid #ccc;
      width: 100%;
      max-width: 400px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }
    .tab:hover {
      background: #f7f7f7;
    }
    .tab.disabled {
      color: #aaa;
      cursor: not-allowed;
      pointer-events: none;
    }
    .tab.active {
      background: #ffe6e6;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 20px;
      max-width: 360px;
      width: 100%;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .idea-block {
      margin-bottom: 10px;
    }
    .idea-block textarea {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: none;
      height: 3.2em;
      line-height: 1.5em;
      overflow-y: auto;
      box-sizing: border-box;
    }
    .add-button, .reset-button {
      background-color: #48c9b0;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
    }
    .add-button {
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .reset-button {
      background-color: #e67e22;
      margin-top: 10px;
    }
    button.main-action {
      background-color: #ff6f61;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: 0.3s;
      width: 100%;
    }
    button.main-action:hover {
      background-color: #e85b4f;
    }
    .result {
      margin-top: 20px;
      font-size: 20px;
      font-weight: bold;
      color: #2c3e50;
      text-align: center;
      padding: 20px;
      background: #fff9c4;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      min-height: 60px;
    }
    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }
    .info-message {
      font-size: 14px;
      color: #666;
      text-align: center;
      margin-bottom: 20px;
    }
    .loading {
      font-size: 18px;
      color: #999;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <h1>üéâ G√©n√©rateur de Date Myst√®re</h1>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('margaux')" id="tab-margaux">Id√©e Margaux</div>
    <div class="tab disabled" id="tab-ulrich">Id√©e Ulric ‚úÖ</div>
    <div class="tab" onclick="switchTab('tirage')" id="tab-tirage">Tirage au sort</div>
  </div>

  <div class="container">
    <!-- √âcran Margaux -->
    <div id="screen-margaux" class="screen active">
      <div class="info-message">Ajoute jusqu'√† 10 id√©es de date. ‚ú®<br>Les id√©es sont partag√©es entre vous deux.</div>
      <div id="ideaList"></div>
      <button class="add-button" onclick="addIdea()">+ Ajouter une id√©e</button>
      <button class="reset-button" onclick="resetIdeas()">R√©initialiser</button>
    </div>

    <!-- √âcran Tirage -->
    <div id="screen-tirage" class="screen">
      <h2>Tirage au Sort üéâ</h2>
      <button class="main-action" onclick="drawDate()">Tirer au sort une id√©e !</button>
      <div class="result" id="result"></div>
    </div>
  </div>

  <script type="module">
    /************************************
     * 1. Imports Firebase
     ************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      getDocs,
      doc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    /************************************
     * 2. CONFIG FIREBASE
     * Remplace l'objet ci-dessous par TA config firebaseConfig
     * (celle que tu m'as envoy√©e avec apiKey, authDomain, etc.)
     ************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyCNzUwspWX6EOqYHHmueq5nmfTTFV5LPbA",
      authDomain: "datemystere-c7580.firebaseapp.com",
      projectId: "datemystere-c7580",
      storageBucket: "datemystere-c7580.firebasestorage.app",
      messagingSenderId: "394663564435",
      appId: "1:394663564435:web:505095cc42c3ad277d6966",
      measurementId: "G-E4H4BR9C4T"
    };

    /************************************
     * 3. Init Firebase + Firestore
     ************************************/
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // On va stocker les id√©es Margaux dans une collection "margauxIdeas"
    const ideasColRef = collection(db, "margauxIdeas");

    // Cache local pour l'affichage et le tirage
    // Chaque id√©e = { id: "...", text: "..." }
    let margauxIdeasCache = [];

    // Id√©es Ulric en dur
    const ulrichIdeas = [
      "Soir√©e sous les √©toiles au Plan√©tarium (je viens te chercher üåå)",
      "Voir un match des Gothiques d‚ÄôAmiens (hockey üî• dans la meilleure division fran√ßaise)",
      "Tour des estaminets secrets üçª (j‚Äôen connais 2-3 p√©pites dans le coin)",
      "Soir√©e Podcast üéß : je t‚Äôinterviewe sur un de tes voyages, fa√ßon podcast intime",
      "Soir√©e Quiz √† Lille üß† : je t‚Äôimpressionne (ou te fais rire) avec ma culture plus ou moins fiable üòÑ"
    ];

    /************************************
     * 4. Changement d'onglet (UI)
     ************************************/
    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('screen-' + tab).classList.add('active');
    }
    window.switchTab = switchTab;

    /************************************
     * 5. Affichage des id√©es Margaux √† l'√©cran
     ************************************/
    function renderIdeaList() {
      const container = document.getElementById('ideaList');
      container.innerHTML = "";

      // Limite 10 id√©es visuellement
      const ideasToRender = margauxIdeasCache.slice(0, 10);

      ideasToRender.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'idea-block';

        // On cr√©e un textarea pr√©-rempli
        const textarea = document.createElement('textarea');
        textarea.value = entry.text || "";
        textarea.placeholder = "Id√©e de date";
        textarea.addEventListener("input", () => {
          // on met √† jour Firestore √† chaque modif
          updateIdea(entry.id, textarea.value);
        });

        div.appendChild(textarea);
        container.appendChild(div);
      });
    }

    /************************************
     * 6. Ajouter une nouvelle id√©e
     ************************************/
    async function addIdea() {
      // V√©rifier qu'on n'a pas d√©j√† 10 id√©es
      if (margauxIdeasCache.length >= 10) {
        alert("Tu ne peux ajouter que 10 id√©es maximum ‚úã");
        return;
      }

      // Cr√©er une nouvelle id√©e vide dans Firestore
      await addDoc(ideasColRef, {
        text: ""
      });
      // Pas besoin d'appeler render() ici car onSnapshot va se d√©clencher
    }
    window.addIdea = addIdea;

    /************************************
     * 7. Mettre √† jour une id√©e existante dans Firestore
     ************************************/
    async function updateIdea(id, newText) {
      const ref = doc(db, "margauxIdeas", id);
      await updateDoc(ref, {
        text: newText
      });
    }

    /************************************
     * 8. R√©initialiser toutes les id√©es Margaux
     ************************************/
    async function resetIdeas() {
      // Supprimer tous les docs dans margauxIdeas
      const snap = await getDocs(ideasColRef);
      const deletions = [];
      snap.forEach(d => {
        deletions.push(deleteDoc(doc(db, "margauxIdeas", d.id)));
      });
      await Promise.all(deletions);

      // Reset affichage r√©sultat tirage
      const resultDiv = document.getElementById("result");
      if (resultDiv) {
        resultDiv.innerHTML = "";
      }
    }
    window.resetIdeas = resetIdeas;

    /************************************
     * 9. Tirage au sort
     ************************************/
    function drawDate() {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = '<div class="loading">‚è≥ Tirage en cours...</div>';

      setTimeout(() => {
        // On prend les id√©es non vides c√¥t√© Margaux
        const margauxClean = margauxIdeasCache
          .map(i => i.text?.trim())
          .filter(x => x && x.length > 0);

        const ulric = ulrichIdeas;

        if (ulric.length === 0 && margauxClean.length === 0) {
          resultDiv.textContent = "Aucune id√©e enregistr√©e pour le moment.";
          return;
        }

        // 50/50 Margaux vs Ulric
        const pickFrom = Math.random() < 0.5 ? "ulric" : "margaux";
        let drawn;

        if (pickFrom === "ulric" && ulric.length > 0) {
          drawn = { text: ulric[Math.floor(Math.random() * ulric.length)], author: "Ulric" };
        } else if (margauxClean.length > 0) {
          drawn = { text: margauxClean[Math.floor(Math.random() * margauxClean.length)], author: "Margaux" };
        } else {
          // fallback si l'un est vide
          const fullList = [
            ...ulric.map(t => ({ text: t, author: "Ulric" })),
            ...margauxClean.map(t => ({ text: t, author: "Margaux" }))
          ];
          drawn = fullList[Math.floor(Math.random() * fullList.length)];
        }

        resultDiv.innerHTML = `üí° <strong>Id√©e tir√©e</strong><br><br><em>${drawn.text}</em><br><br><small>‚ú® propos√©e par <strong>${drawn.author}</strong></small>`;
      }, 800);
    }
    window.drawDate = drawDate;

    /************************************
     * 10. √âcoute temps r√©el Firestore
     *     -> met √† jour margauxIdeasCache quand il y a un changement
     *     -> rafra√Æchit l'affichage
     ************************************/
    onSnapshot(ideasColRef, (snapshot) => {
      const data = [];
      snapshot.forEach(docSnap => {
        data.push({
          id: docSnap.id,
          ...docSnap.data()
        });
      });

      // on garde l'ordre stable : le plus ancien en premier
      // Firestore ne garantit pas l'ordre par d√©faut donc on ne trie pas par d√©faut,
      // mais si tu veux tu peux trier alpha :
      // data.sort((a, b) => (a.text || "").localeCompare(b.text || "", "fr"));

      margauxIdeasCache = data;
      renderIdeaList();
    });

    /************************************
     * 11. Initialisation visuelle
     ************************************/
    // Quand la page se charge, l'√©coute onSnapshot va remplir la liste automatiquement.
    // Donc pas besoin d'appeler addIdea() ici.
  </script>
</body>
</html>
