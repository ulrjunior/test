<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Date Myst√®re ‚ú®</title>
  <style>
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', sans-serif;
      background: radial-gradient(circle at 20% 20%, #ffe6e6 0%, #fff 30%, #e0f7fa 100%);
      margin: 0;
      padding: 0 16px 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #2c3e50;
    }

    h1 {
      color: #2c3e50;
      margin-top: 20px;
      margin-bottom: 8px;
      text-align: center;
      font-size: 1.5rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
      margin-bottom: 16px;
    }

    /* Tabs / Onglets */
    .tabs {
      display: flex;
      justify-content: center;
      background: #ffffffcc;
      border: 1px solid #ddd;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      line-height: 1.2rem;
      transition: background 0.2s, color 0.2s;
      user-select: none;
      border-right: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
    }

    .tab:last-child {
      border-right: none;
    }

    .tab.active {
      background: #ffe6e6;
      color: #2c3e50;
    }

    .tab.locked {
      color: #999;
    }

    .tab.locked.needs-code {
      cursor: pointer;
      color: #444;
    }

    /* Cards / Conteneur */
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 20px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 12px 32px rgba(0,0,0,0.07);
      margin-top: 20px;
    }

    .info-message {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
      margin-bottom: 20px;
      line-height: 1.4rem;
    }

    .idea-block {
      margin-bottom: 10px;
    }

    .idea-block textarea {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #ccc;
      resize: none;
      height: 3.2em;
      line-height: 1.5em;
      overflow-y: auto;
      box-sizing: border-box;
      background-color: #fff;
      color: #2c3e50;
    }

    .idea-block textarea:focus {
      outline: 2px solid #ffb3b3;
      border-color: #ff8a80;
    }

    .small-hint {
      font-size: 0.8rem;
      color: #888;
      margin-top: 6px;
      text-align: center;
      line-height: 1.2rem;
    }

    /* Buttons */
    .btn-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
    }

    button.action-btn {
      background-color: #48c9b0;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      min-height: 44px;
      box-shadow: 0 6px 16px rgba(72,201,176,0.4);
    }

    button.reset-btn {
      background-color: #e67e22;
      box-shadow: 0 6px 16px rgba(230,126,34,0.4);
    }

    button.draw-btn {
      background-color: #ff6f61;
      box-shadow: 0 6px 16px rgba(255,111,97,0.4);
      font-size: 15px;
    }

    button.action-btn:active {
      transform: scale(0.99);
    }

    /* Result block */
    .result {
      margin-top: 20px;
      font-size: 1rem;
      font-weight: 600;
      color: #2c3e50;
      text-align: center;
      padding: 16px;
      background: #fff9c4;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      min-height: 60px;
      line-height: 1.4rem;
    }

    .loading {
      font-size: 1rem;
      color: #999;
      text-align: center;
      padding: 20px;
    }

    /* Screens (onglets contenus) */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* MODAL PASSWORD */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      border-radius: 16px;
      width: 90%;
      max-width: 320px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      padding: 20px 20px 16px;
      text-align: center;
      color: #2c3e50;
      position: relative;
    }

    .modal-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    .modal-desc {
      font-size: 0.85rem;
      color: #666;
      line-height: 1.3rem;
      margin-bottom: 16px;
    }

    .pass-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      text-align: center;
      letter-spacing: 0.15em;
      font-weight: 600;
      color: #2c3e50;
    }

    .pass-input:focus {
      outline: 2px solid #a5d6a7;
      border-color: #4caf50;
    }

    .modal-btn-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 18px;
    }

    .modal-btn {
      background-color: #4caf50;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      box-shadow: 0 6px 16px rgba(76,175,80,0.4);
    }

    .modal-cancel {
      background-color: #ccc;
      color: #333;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    .wrong-msg {
      font-size: 0.8rem;
      color: #e53935;
      margin-top: 6px;
      min-height: 1em;
    }

    /* Footer hint */
    .footer-hint {
      font-size: 0.75rem;
      line-height: 1rem;
      color: #666;
      text-align: center;
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <h1>üéâ G√©n√©rateur de Date Myst√®re</h1>
  <div class="subtitle">Vos id√©es partag√©es (et quelques surprises)</div>

  <!-- ONGLET HEADER -->
  <div class="tabs">
    <div class="tab active" id="tab-margaux" onclick="goMargaux()">Id√©e Margaux</div>
    <div class="tab locked needs-code" id="tab-ulric" onclick="requestUlric()">Id√©e Ulric üîí</div>
    <div class="tab" id="tab-tirage" onclick="goTirage()">Tirage au sort</div>
  </div>

  <!-- CONTENU -->
  <div class="card">
    <!-- √âcran Margaux -->
    <div id="screen-margaux" class="screen active">
      <div class="info-message">
        Ajoute jusqu'√† 10 id√©es de date. ‚ú®<br>
        Les id√©es sont partag√©es entre vous deux en temps r√©el.
      </div>

      <div id="ideaList"></div>

      <div class="btn-row">
        <button class="action-btn" onclick="addIdea()">+ Ajouter une id√©e</button>
        <button class="action-btn reset-btn" onclick="resetIdeas()">R√©initialiser</button>
      </div>

      <div class="small-hint">
        Quand tu √©cris dans une case, c'est sauvegard√© automatiquement.
      </div>
    </div>

    <!-- √âcran Ulric -->
    <div id="screen-ulric" class="screen">
      <div class="info-message">
        Id√©es surprises pr√©par√©es par Ulric üòè<br>
        (ne pas lire si tu veux garder l'effet waouh üôà)
      </div>

      <div id="ulricList"></div>

      <div class="small-hint">
        Ces id√©es ne sont visibles que si tu connais le code.
      </div>
    </div>

    <!-- √âcran Tirage -->
    <div id="screen-tirage" class="screen">
      <div class="info-message">
        On m√©lange vos id√©es üíò<br>
        et on laisse le destin choisir.
      </div>

      <div class="btn-row">
        <button class="action-btn draw-btn" onclick="drawDate()">Tirer au sort une id√©e ! üé≤</button>
      </div>

      <div class="result" id="result"></div>
    </div>
  </div>

  <div class="footer-hint">
    Cr√©√© pour vous deux üíû ‚Äî les id√©es se mettent √† jour sur vos t√©l√©phones.
  </div>

  <!-- MODAL MOT DE PASSE ULRIC -->
  <div class="modal-overlay" id="passModal">
    <div class="modal">
      <div class="modal-title">Acc√®s id√©es Ulric üîê</div>
      <div class="modal-desc">
        Certaines id√©es sont secr√®tes (effet surprise üòè).<br>
        Entre le code pour les afficher :
      </div>

      <input
        id="passField"
        class="pass-input"
        type="password"
        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        inputmode="numeric"
      />

      <div class="wrong-msg" id="wrongMsg"></div>

      <div class="modal-btn-row">
        <button class="modal-btn" onclick="validatePass()">Valider</button>
        <button class="modal-btn modal-cancel" onclick="cancelPass()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT APP + FIREBASE -->
  <script type="module">
    /************************************
     * 1. Firebase imports
     ************************************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      updateDoc,
      deleteDoc,
      getDocs,
      doc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    /************************************
     * 2. Firebase config
     * (ta config projet actuelle)
     ************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyCNzUwspWX6EOqYHHmueq5nmfTTFV5LPbA",
      authDomain: "datemystere-c7580.firebaseapp.com",
      projectId: "datemystere-c7580",
      storageBucket: "datemystere-c7580.firebasestorage.app",
      messagingSenderId: "394663564435",
      appId: "1:394663564435:web:505095cc42c3ad277d6966",
      measurementId: "G-E4H4BR9C4T"
    };

    /************************************
     * 3. Init Firebase / Firestore
     ************************************/
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Collection partag√©e Margaux ‚Üí Firestore
    const ideasColRef = collection(db, "margauxIdeas");

    // Cache local pour les id√©es de Margaux
    // Chaque entr√©e : { id: "...", text: "..." }
    let margauxIdeasCache = [];

    // Id√©es Ulric (cach√©es derri√®re le code)
    const ulricIdeas = [
      "Soir√©e sous les √©toiles au Plan√©tarium (je viens te chercher üåå)",
      "Voir un match de hockey üî• dans une patinoire o√π √ßa tape fort",
      "Tour des estaminets cach√©s üçª (je t‚Äôemm√®ne dans des endroits o√π t‚Äôes jamais all√©e)",
      "Soir√©e Podcast üéß : je t‚Äôinterviewe sur un de tes voyages, fa√ßon documentaire",
      "Soir√©e Quiz √† Lille üß† : je pr√©pare un quiz perso sur nous deux",
      "Roadtrip spontan√© : on monte en voiture, pas de plan, juste une direction",
      "Brunch maison + march√© aux puces le dimanche matin ‚òïüßÅ",
      "Session Polaroid en mode touristes dans notre propre ville üì∏",
      "Patinoire ou roller disco üòè",
      "Mini d√©fi sport + resto doudou derri√®re (on se donne faim)"
    ];

    // Flag acc√®s aux id√©es Ulric
    let ulricUnlocked = false;
    const ACCESS_CODE = "06081998";

    /************************************
     * 4. Rendu UI : onglets
     ************************************/
    function activateTab(tabName) {
      // onglets visuels
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      // √©crans
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));

      // activer l'onglet correspondant
      const tabEl = document.getElementById('tab-' + tabName);
      if (tabEl) tabEl.classList.add('active');

      // activer l'√©cran correspondant
      const screenEl = document.getElementById('screen-' + tabName);
      if (screenEl) screenEl.classList.add('active');
    }

    // Ces fonctions sont appel√©es par les onglets
    function goMargaux() {
      activateTab('margaux');
    }

    function goTirage() {
      activateTab('tirage');
    }

    function requestUlric() {
      if (ulricUnlocked) {
        // d√©j√† d√©bloqu√©
        activateTab('ulric');
        return;
      }
      openPassModal();
    }

    // On les expose au HTML
    window.goMargaux = goMargaux;
    window.goTirage = goTirage;
    window.requestUlric = requestUlric;

    /************************************
     * 5. Modal mot de passe
     ************************************/
    const passModal = document.getElementById("passModal");
    const passField = document.getElementById("passField");
    const wrongMsg = document.getElementById("wrongMsg");

    function openPassModal() {
      wrongMsg.textContent = "";
      passField.value = "";
      passModal.style.display = "flex";
      // petit d√©lai pour garantir le focus apr√®s affichage
      setTimeout(() => {
        passField.focus();
      }, 50);
    }

    function closePassModal() {
      passModal.style.display = "none";
    }

    function validatePass() {
      const val = passField.value.trim();
      if (val === ACCESS_CODE) {
        ulricUnlocked = true;
        closePassModal();
        // enlever le style "locked" visuellement
        const ulricTab = document.getElementById("tab-ulric");
        ulricTab.classList.remove("locked", "needs-code");
        activateTab('ulric');
      } else {
        // mauvais code
        wrongMsg.textContent = "Code incorrect üôà";
        ulricUnlocked = false;
        // on ferme le modal et on revient sur Margaux
        setTimeout(() => {
          closePassModal();
          activateTab('margaux');
        }, 800);
      }
    }

    function cancelPass() {
      closePassModal();
      activateTab('margaux');
    }

    // exposer pour boutons modal
    window.validatePass = validatePass;
    window.cancelPass = cancelPass;

    /************************************
     * 6. Affichage liste Margaux
     *    (avec pr√©servation du focus)
     ************************************/
    // timers pour limiter les updates Firestore
    const updateTimers = {};

    async function updateIdea(id, newText) {
      // DEBOUNCE : on n'envoie pas chaque lettre, on attend un instant
      clearTimeout(updateTimers[id]);
      updateTimers[id] = setTimeout(async () => {
        const ref = doc(db, "margauxIdeas", id);
        await updateDoc(ref, { text: newText });
      }, 400);
    }

    function renderIdeaList() {
      const container = document.getElementById('ideaList');

      // garder ce qu'on est en train d'√©diter
      const active = document.activeElement;
      const activeId = active?.dataset?.id;
      const cursorPos = active?.selectionStart || 0;

      container.innerHTML = "";

      const ideasToRender = margauxIdeasCache.slice(0, 10);

      ideasToRender.forEach(entry => {
        const wrap = document.createElement('div');
        wrap.className = 'idea-block';

        const textarea = document.createElement('textarea');
        textarea.value = entry.text || "";
        textarea.placeholder = "Id√©e de date";
        textarea.dataset.id = entry.id;

        textarea.addEventListener("input", () => {
          updateIdea(entry.id, textarea.value);
        });

        wrap.appendChild(textarea);
        container.appendChild(wrap);
      });

      // remets le focus l√† o√π tu √©crivais
      if (activeId) {
        const newActive = container.querySelector(`textarea[data-id='${activeId}']`);
        if (newActive) {
          newActive.focus();
          try { newActive.setSelectionRange(cursorPos, cursorPos); } catch(e){}
        }
      }
    }

    /************************************
     * 7. Ajouter / Reset id√©es Margaux
     ************************************/
    async function addIdea() {
      if (margauxIdeasCache.length >= 10) {
        alert("Tu ne peux ajouter que 10 id√©es maximum ‚úã");
        return;
      }
      await addDoc(ideasColRef, {
        text: ""
      });
    }
    window.addIdea = addIdea;

    async function resetIdeas() {
      const snap = await getDocs(ideasColRef);
      const deletions = [];
      snap.forEach(d => {
        deletions.push(deleteDoc(doc(db, "margauxIdeas", d.id)));
      });
      await Promise.all(deletions);

      const resultDiv = document.getElementById("result");
      if (resultDiv) {
        resultDiv.innerHTML = "";
      }
    }
    window.resetIdeas = resetIdeas;

    /************************************
     * 8. Affichage id√©es Ulric (en lecture seule)
     ************************************/
    function renderUlricList() {
      const ulricList = document.getElementById("ulricList");
      ulricList.innerHTML = "";

      ulricIdeas.forEach(text => {
        const block = document.createElement('div');
        block.className = 'idea-block';

        const ta = document.createElement('textarea');
        ta.value = text;
        ta.readOnly = true;
        ta.style.backgroundColor = "#fdfdfd";
        ta.style.borderColor = "#bbb";
        ta.style.color = "#2c3e50";

        block.appendChild(ta);
        ulricList.appendChild(block);
      });
    }

    /************************************
     * 9. Tirage (m√©lange Margaux & Ulric)
     ************************************/
    function drawDate() {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = '<div class="loading">‚è≥ Tirage en cours...</div>';

      setTimeout(() => {
        // id√©es propres de Margaux
        const margauxClean = margauxIdeasCache
          .map(i => i.text?.trim())
          .filter(x => x && x.length > 0);

        const ulric = ulricIdeas;

        if (ulric.length === 0 && margauxClean.length === 0) {
          resultDiv.textContent = "Aucune id√©e enregistr√©e pour le moment.";
          return;
        }

        // 50/50 Margaux vs Ulric d'abord...
        const pickFrom = Math.random() < 0.5 ? "ulric" : "margaux";
        let drawn;

        if (pickFrom === "ulric" && ulric.length > 0) {
          drawn = { text: ulric[Math.floor(Math.random() * ulric.length)], author: "Ulric" };
        } else if (margauxClean.length > 0) {
          drawn = { text: margauxClean[Math.floor(Math.random() * margauxClean.length)], author: "Margaux" };
        } else {
          // fallback : m√©lange total
          const fullList = [
            ...ulric.map(t => ({ text: t, author: "Ulric" })),
            ...margauxClean.map(t => ({ text: t, author: "Margaux" }))
          ];
          drawn = fullList[Math.floor(Math.random() * fullList.length)];
        }

        resultDiv.innerHTML =
          `üí° <strong>Id√©e tir√©e</strong><br><br>` +
          `<em>${drawn.text}</em><br><br>` +
          `<small>‚ú® propos√©e par <strong>${drawn.author}</strong></small>`;
      }, 600);
    }
    window.drawDate = drawDate;

    /************************************
     * 10. Sync temps r√©el Firestore (Margaux)
     ************************************/
    onSnapshot(ideasColRef, (snapshot) => {
      const data = [];
      snapshot.forEach(docSnap => {
        data.push({
          id: docSnap.id,
          ...docSnap.data()
        });
      });
      margauxIdeasCache = data;
      renderIdeaList();
    });

    /************************************
     * 11. Init au chargement
     ************************************/
    renderUlricList(); // remplir l'onglet Ulric (lecture seule)
    // l'onglet Margaux se remplit via onSnapshot d√®s qu'on re√ßoit les donn√©es
  </script>
</body>
</html>
